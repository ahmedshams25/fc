<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بطولة فيفا - 3 فرق لكل لاعب</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #1abc9c;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            text-align: center;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .logo {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            color: var(--gold);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        h2 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.4rem;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        h2 i {
            margin-left: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button i {
            margin-left: 8px;
        }
        
        button:hover {
            background-color: #16a085;
        }
        
        .btn-danger {
            background-color: var(--accent);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-primary {
            background-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: #1a252f;
        }
        
        .player {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .player h3 {
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .player h3 i {
            margin-left: 8px;
            color: var(--secondary);
        }
        
        .team-list {
            list-style: none;
        }
        
        .team-list li {
            background-color: white;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--secondary);
        }
        
        .remove-team {
            color: var(--accent);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .remove-player {
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--accent);
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .tournament-status {
            text-align: center;
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px;
            background-color: var(--light);
            border-radius: 8px;
            font-weight: bold;
        }
        
        .match {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--secondary);
        }
        
        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .match-team {
            flex: 1;
            text-align: center;
            padding: 5px;
        }
        
        .match-vs {
            font-weight: bold;
            padding: 0 10px;
        }
        
        .match-result {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        
        .match-result input {
            width: 50px;
            text-align: center;
            margin: 0 5px;
        }
        
        .match-submit {
            margin-top: 10px;
        }
        
        .winner {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .loser {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        
        .hidden {
            display: none;
        }
        
        .history-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
        }
        
        .history-item h3 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .history-item h3 i {
            margin-left: 8px;
            color: var(--gold);
        }
        
        .history-date {
            font-size: 0.8rem;
            color: #777;
            margin-bottom: 10px;
        }
        
        .history-winner {
            background-color: var(--light);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .history-teams {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .history-team {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
        }
        
        .tab:hover:not(.active) {
            border-bottom: 3px solid #ddd;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 200px;
            margin: 20px 0;
        }
        
        .podium-step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 120px;
        }
        
        .podium-first {
            height: 150px;
            background-color: var(--gold);
        }
        
        .podium-second {
            height: 100px;
            background-color: var(--silver);
        }
        
        .podium-third {
            height: 70px;
            background-color: var(--bronze);
        }
        
        .podium-rank {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .podium-player {
            font-weight: bold;
            margin-top: 10px;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
            }
            
            .players-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .player {
                margin-bottom: 0;
            }
            
            .history-teams {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-trophy"></i>
            </div>
            <h1>بطولة فيفا - 3 فرق لكل لاعب</h1>
            <p>قم بتنظيم بطولتك مع الأصدقاء</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="setup">إعداد البطولة</div>
            <div class="tab" data-tab="history">سجل البطولات</div>
        </div>
        
        <div id="setup-content" class="tab-content active">
            <section class="section" id="setup-section">
                <h2><i class="fas fa-cog"></i> إعداد البطولة</h2>
                
                <div class="form-group">
                    <label for="player-name"><i class="fas fa-user"></i> اسم اللاعب</label>
                    <input type="text" id="player-name" placeholder="أدخل اسم اللاعب">
                </div>
                
                <div class="form-group">
                    <label for="team-select"><i class="fas fa-users"></i> اختر فريق</label>
                    <select id="team-select">
                        <option value="">-- اختر فريق --</option>
                        <option value="ريال مدريد">ريال مدريد</option>
                        <option value="برشلونة">برشلونة</option>
                        <option value="بايرن ميونخ">بايرن ميونخ</option>
                        <option value="مانشستر سيتي">مانشستر سيتي</option>
                        <option value="ليفربول">ليفربول</option>
                        <option value="باريس سان جيرمان">باريس سان جيرمان</option>
                        <option value="يوفنتوس">يوفنتوس</option>
                        <option value="تشيلسي">تشيلسي</option>
                        <option value="مانشستر يونايتد">مانشستر يونايتد</option>
                        <option value="أرسنال">أرسنال</option>
                        <option value="أتلتيكو مدريد">أتلتيكو مدريد</option>
                        <option value="إنتر ميلان">إنتر ميلان</option>
                        <option value="ميلان">ميلان</option>
                        <option value="توتنهام">توتنهام</option>
                        <option value="دورتموند">دورتموند</option>
                        <option value="أخرى...">أخرى...</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="custom-team-group">
                    <label for="custom-team"><i class="fas fa-plus-circle"></i> اسم الفريق المخصص</label>
                    <input type="text" id="custom-team" placeholder="أدخل اسم الفريق">
                </div>
                
                <button id="add-team-btn"><i class="fas fa-plus"></i> إضافة فريق للاعب</button>
                <button id="add-player-btn"><i class="fas fa-user-plus"></i> إضافة لاعب جديد</button>
                <button id="start-tournament-btn" class="hidden"><i class="fas fa-play"></i> بدء البطولة</button>
            </section>
            
            <section class="section" id="players-section">
                <h2><i class="fas fa-users"></i> اللاعبون وفرقهم</h2>
                <div id="players-container" class="players-container">
                    <!-- سيتم إضافة اللاعبين هنا -->
                </div>
            </section>
        </div>
        
        <div id="tournament-content" class="tab-content">
            <section class="section" id="tournament-section">
                <h2><i class="fas fa-trophy"></i> البطولة</h2>
                <div id="tournament-status" class="tournament-status">
                    جاري إعداد المباريات...
                </div>
                <div id="matches-container">
                    <!-- سيتم إضافة المباريات هنا -->
                </div>
            </section>
        </div>
        
        <div id="results-content" class="tab-content">
            <section class="section" id="results-section">
                <h2><i class="fas fa-medal"></i> النتائج النهائية</h2>
                <div id="final-results">
                    <!-- سيتم عرض النتائج النهائية هنا -->
                </div>
            </section>
        </div>
        
        <div id="history-content" class="tab-content">
            <section class="section" id="history-section">
                <h2><i class="fas fa-history"></i> سجل البطولات</h2>
                <div id="history-container">
                    <!-- سيتم عرض البطولات السابقة هنا -->
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyD5gpwJFHEFr1ePwdQ6sV_kUVXomtVss9U",
                authDomain: "fc-mobile-9502f.firebaseapp.com",
                projectId: "fc-mobile-9502f",
                storageBucket: "fc-mobile-9502f.firebasestorage.app",
                messagingSenderId: "306392548442",
                appId: "1:306392548442:web:fb0f8467a407675ae24463",
                measurementId: "G-T7EXKHF2DE"
            };
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const analytics = firebase.analytics();
            
            // العناصر الرئيسية
            const playerNameInput = document.getElementById('player-name');
            const teamSelect = document.getElementById('team-select');
            const customTeamGroup = document.getElementById('custom-team-group');
            const customTeamInput = document.getElementById('custom-team');
            const addTeamBtn = document.getElementById('add-team-btn');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const startTournamentBtn = document.getElementById('start-tournament-btn');
            const playersContainer = document.getElementById('players-container');
            const setupSection = document.getElementById('setup-section');
            const tournamentSection = document.getElementById('tournament-section');
            const resultsSection = document.getElementById('results-section');
            const historySection = document.getElementById('history-section');
            const matchesContainer = document.getElementById('matches-container');
            const tournamentStatus = document.getElementById('tournament-status');
            const finalResults = document.getElementById('final-results');
            const historyContainer = document.getElementById('history-container');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = {
                setup: document.getElementById('setup-content'),
                tournament: document.getElementById('tournament-content'),
                results: document.getElementById('results-content'),
                history: document.getElementById('history-content')
            };
            
            // بيانات التطبيق
            let players = [];
            let currentPlayer = null;
            let matches = [];
            let tournamentStarted = false;
            let currentTournamentId = null;
            
            // تحميل البطولات السابقة
            function loadHistory() {
                historyContainer.innerHTML = '<p>جاري تحميل البطولات السابقة...</p>';
                
                db.collection('tournaments').orderBy('date', 'desc').limit(10).get()
                    .then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            historyContainer.innerHTML = '<p>لا توجد بطولات سابقة</p>';
                            return;
                        }
                        
                        historyContainer.innerHTML = '';
                        
                        querySnapshot.forEach((doc) => {
                            const tournament = doc.data();
                            renderHistoryItem(tournament);
                        });
                    })
                    .catch((error) => {
                        console.error("Error loading history: ", error);
                        historyContainer.innerHTML = '<p>حدث خطأ في تحميل البطولات السابقة</p>';
                    });
            }
            
            // عرض عنصر في سجل البطولات
            function renderHistoryItem(tournament) {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(tournament.date.seconds * 1000);
                const dateStr = date.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                historyItem.innerHTML = `
                    <h3><i class="fas fa-trophy"></i> ${tournament.name}</h3>
                    <div class="history-date">${dateStr}</div>
                    <div class="history-winner">
                        <i class="fas fa-crown"></i> الفائز: ${tournament.winner.player} (${tournament.winner.teams.join('، ')})
                    </div>
                    <h4>الفرق المشاركة:</h4>
                    <div class="history-teams">
                        ${tournament.allTeams.map(team => `
                            <div class="history-team">
                                ${team.name} (${team.player})
                            </div>
                        `).join('')}
                    </div>
                `;
                
                historyContainer.appendChild(historyItem);
            }
            
            // تبديل بين التبويبات
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // إزالة التنشيط من جميع التبويبات والمحتويات
                    tabs.forEach(t => t.classList.remove('active'));
                    Object.values(tabContents).forEach(c => c.classList.remove('active'));
                    
                    // تنشيط التبويب المحدد والمحتوى المرتبط
                    tab.classList.add('active');
                    
                    if (tabId === 'setup') {
                        tabContents.setup.classList.add('active');
                    } 
                    else if (tabId === 'history') {
                        tabContents.history.classList.add('active');
                        loadHistory();
                    }
                    else if (tabId === 'tournament') {
                        tabContents.tournament.classList.add('active');
                    }
                    else if (tabId === 'results') {
                        tabContents.results.classList.add('active');
                    }
                });
            });
            
            // عرض الفرق المتبقية لكل لاعب
            function updateRemainingTeams() {
                const playersWithTeams = players.filter(player => player.teams.length > 0);
                if (playersWithTeams.length >= 2) {
                    startTournamentBtn.classList.remove('hidden');
                } else {
                    startTournamentBtn.classList.add('hidden');
                }
            }
            
            // إظهار/إخفاء حقل الفريق المخصص
            teamSelect.addEventListener('change', function() {
                if (this.value === 'أخرى...') {
                    customTeamGroup.classList.remove('hidden');
                } else {
                    customTeamGroup.classList.add('hidden');
                }
            });
            
            // إضافة فريق للاعب الحالي
            addTeamBtn.addEventListener('click', function() {
                const playerName = playerNameInput.value.trim();
                let teamName = teamSelect.value;
                
                if (teamName === 'أخرى...') {
                    teamName = customTeamInput.value.trim();
                }
                
                if (!playerName) {
                    alert('الرجاء إدخال اسم اللاعب');
                    return;
                }
                
                if (!teamName) {
                    alert('الرجاء اختيار أو إدخال اسم الفريق');
                    return;
                }
                
                // البحث عن اللاعب الحالي أو إنشاء لاعب جديد
                let player = players.find(p => p.name === playerName);
                
                if (!player) {
                    player = { name: playerName, teams: [] };
                    players.push(player);
                }
                
                // التحقق من أن اللاعب ليس لديه 3 فرق بالفعل
                if (player.teams.length >= 3) {
                    alert('كل لاعب يمكنه اختيار 3 فرق فقط');
                    return;
                }
                
                // التحقق من أن الفريق لم يتم اختياره من قبل
                const teamAlreadyTaken = players.some(p => 
                    p.teams.some(t => t.name === teamName)
                );
                
                if (teamAlreadyTaken) {
                    alert('هذا الفريق已被另一玩家選擇了');
                    return;
                }
                
                // إضافة الفريق للاعب
                player.teams.push({ name: teamName, eliminated: false });
                currentPlayer = player;
                
                // تحديث العرض
                renderPlayers();
                updateRemainingTeams();
                
                // مسح الحقول
                teamSelect.value = '';
                customTeamInput.value = '';
                customTeamGroup.classList.add('hidden');
            });
            
            // إضافة لاعب جديد
            addPlayerBtn.addEventListener('click', function() {
                playerNameInput.value = '';
                teamSelect.value = '';
                customTeamInput.value = '';
                customTeamGroup.classList.add('hidden');
                currentPlayer = null;
            });
            
            // بدء البطولة
            startTournamentBtn.addEventListener('click', function() {
                if (players.filter(p => p.teams.length > 0).length < 2) {
                    alert('يجب أن يكون هناك على الأقل لاعبين لديهم فرق للمشاركة');
                    return;
                }
                
                tournamentStarted = true;
                
                // تبديل إلى تبويب البطولة
                tabs.forEach(t => t.classList.remove('active'));
                Object.values(tabContents).forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="tournament"]').classList.add('active');
                tabContents.tournament.classList.add('active');
                
                // إنشاء معرف فريد للبطولة
                currentTournamentId = Date.now().toString();
                
                // إنشاء المباريات
                generateMatches();
                renderMatches();
            });
            
            // عرض اللاعبين وفرقهم
            function renderPlayers() {
                playersContainer.innerHTML = '';
                
                players.forEach(player => {
                    if (player.teams.length === 0) return;
                    
                    const playerEl = document.createElement('div');
                    playerEl.className = 'player';
                    
                    const playerTitle = document.createElement('h3');
                    playerTitle.innerHTML = `<i class="fas fa-user"></i> ${player.name}`;
                    
                    const teamList = document.createElement('ul');
                    teamList.className = 'team-list';
                    
                    player.teams.forEach((team, index) => {
                        const teamItem = document.createElement('li');
                        teamItem.textContent = team.name;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-team';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.addEventListener('click', () => {
                            player.teams.splice(index, 1);
                            renderPlayers();
                            updateRemainingTeams();
                        });
                        
                        teamItem.appendChild(removeBtn);
                        teamList.appendChild(teamItem);
                    });
                    
                    const removePlayerBtn = document.createElement('button');
                    removePlayerBtn.className = 'remove-player';
                    removePlayerBtn.innerHTML = '&times;';
                    removePlayerBtn.addEventListener('click', () => {
                        players = players.filter(p => p.name !== player.name);
                        renderPlayers();
                        updateRemainingTeams();
                    });
                    
                    playerEl.appendChild(removePlayerBtn);
                    playerEl.appendChild(playerTitle);
                    playerEl.appendChild(teamList);
                    playersContainer.appendChild(playerEl);
                });
            }
            
            // إنشاء المباريات
            function generateMatches() {
                matches = [];
                let activeTeams = [];
                
                // جمع جميع الفرق النشطة (غير المغلقة)
                players.forEach(player => {
                    player.teams.forEach(team => {
                        if (!team.eliminated) {
                            activeTeams.push({
                                name: team.name,
                                player: player.name
                            });
                        }
                    });
                });
                
                // إذا كان هناك فريق واحد فقط، فهو الفائز
                if (activeTeams.length === 1) {
                    tournamentStatus.textContent = `الفائز هو ${activeTeams[0].player} بفريقه ${activeTeams[0].name}`;
                    saveTournament(activeTeams[0]);
                    showFinalResults();
                    return;
                }
                
                // إذا كان عدد الفرق فردي، فريق واحد يتأهل تلقائياً
                let byeTeam = null;
                if (activeTeams.length % 2 !== 0) {
                    const randomIndex = Math.floor(Math.random() * activeTeams.length);
                    byeTeam = activeTeams.splice(randomIndex, 1)[0];
                    tournamentStatus.textContent = `${byeTeam.name} (${byeTeam.player}) يتأهل تلقائياً لهذه الجولة`;
                } else {
                    tournamentStatus.textContent = `جولة جديدة مع ${activeTeams.length} فرق`;
                }
                
                // خلط الفرق لإنشاء مباريات عشوائية
                activeTeams = shuffleArray(activeTeams);
                
                // إنشاء المباريات
                for (let i = 0; i < activeTeams.length; i += 2) {
                    if (i + 1 < activeTeams.length) {
                        matches.push({
                            team1: activeTeams[i],
                            team2: activeTeams[i + 1],
                            score1: null,
                            score2: null,
                            winner: null
                        });
                    }
                }
            }
            
            // عرض المباريات
            function renderMatches() {
                matchesContainer.innerHTML = '';
                
                if (matches.length === 0) {
                    generateMatches();
                    if (matches.length === 0) return;
                }
                
                matches.forEach((match, index) => {
                    const matchEl = document.createElement('div');
                    matchEl.className = 'match';
                    
                    const matchTeams = document.createElement('div');
                    matchTeams.className = 'match-teams';
                    
                    const team1El = document.createElement('div');
                    team1El.className = 'match-team';
                    team1El.textContent = `${match.team1.name} (${match.team1.player})`;
                    
                    const vsEl = document.createElement('div');
                    vsEl.className = 'match-vs';
                    vsEl.textContent = 'vs';
                    
                    const team2El = document.createElement('div');
                    team2El.className = 'match-team';
                    team2El.textContent = `${match.team2.name} (${match.team2.player})`;
                    
                    matchTeams.appendChild(team1El);
                    matchTeams.appendChild(vsEl);
                    matchTeams.appendChild(team2El);
                    
                    const matchResult = document.createElement('div');
                    matchResult.className = 'match-result';
                    
                    const score1Input = document.createElement('input');
                    score1Input.type = 'number';
                    score1Input.min = '0';
                    score1Input.placeholder = '0';
                    score1Input.value = match.score1 || '';
                    
                    const score2Input = document.createElement('input');
                    score2Input.type = 'number';
                    score2Input.min = '0';
                    score2Input.placeholder = '0';
                    score2Input.value = match.score2 || '';
                    
                    matchResult.appendChild(score1Input);
                    matchResult.appendChild(document.createTextNode('-'));
                    matchResult.appendChild(score2Input);
                    
                    const submitBtn = document.createElement('button');
                    submitBtn.className = 'match-submit';
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> تأكيد النتيجة';
                    
                    submitBtn.addEventListener('click', () => {
                        const score1 = parseInt(score1Input.value);
                        const score2 = parseInt(score2Input.value);
                        
                        if (isNaN(score1)) {
                            alert('الرجاء إدخال نتيجة صحيحة للفريق الأول');
                            return;
                        }
                        
                        if (isNaN(score2)) {
                            alert('الرجاء إدخال نتيجة صحيحة للفريق الثاني');
                            return;
                        }
                        
                        match.score1 = score1;
                        match.score2 = score2;
                        
                        if (score1 > score2) {
                            match.winner = match.team1;
                            eliminateTeam(match.team2);
                        } else if (score2 > score1) {
                            match.winner = match.team2;
                            eliminateTeam(match.team1);
                        } else {
                            // في حالة التعادل، يتم اختيار الفائز عشوائياً
                            const randomWinner = Math.random() < 0.5 ? match.team1 : match.team2;
                            match.winner = randomWinner;
                            eliminateTeam(randomWinner === match.team1 ? match.team2 : match.team1);
                        }
                        
                        // تحديث العرض
                        generateMatches();
                        renderMatches();
                        
                        // التحقق من وجود فائز
                        checkTournamentWinner();
                    });
                    
                    matchEl.appendChild(matchTeams);
                    matchEl.appendChild(matchResult);
                    matchEl.appendChild(submitBtn);
                    matchesContainer.appendChild(matchEl);
                });
            }
            
            // إقصاء فريق
            function eliminateTeam(team) {
                players.forEach(player => {
                    if (player.name === team.player) {
                        player.teams.forEach(t => {
                            if (t.name === team.name) {
                                t.eliminated = true;
                            }
                        });
                    }
                });
            }
            
            // التحقق من وجود فائز
            function checkTournamentWinner() {
                let remainingPlayers = [];
                
                players.forEach(player => {
                    const activeTeams = player.teams.filter(team => !team.eliminated);
                    if (activeTeams.length > 0) {
                        remainingPlayers.push({
                            player: player.name,
                            teams: activeTeams.map(t => t.name),
                            count: activeTeams.length
                        });
                    }
                });
                
                if (remainingPlayers.length === 1) {
                    const winner = remainingPlayers[0];
                    tournamentStatus.textContent = `الفائز هو ${winner.player} مع ${winner.count} فريق/فرق باقية!`;
                    saveTournament(winner);
                    showFinalResults(winner);
                } else if (remainingPlayers.length === 0) {
                    tournamentStatus.textContent = 'انتهت البطولة بدون فائز!';
                    showFinalResults();
                }
            }
            
            // حفظ البطولة في Firebase
            function saveTournament(winner) {
                if (!currentTournamentId) return;
                
                // جمع جميع الفرق المشاركة
                const allTeams = [];
                players.forEach(player => {
                    player.teams.forEach(team => {
                        allTeams.push({
                            name: team.name,
                            player: player.name,
                            eliminated: team.eliminated
                        });
                    });
                });
                
                const tournamentData = {
                    id: currentTournamentId,
                    name: `بطولة فيفا ${new Date().toLocaleDateString('ar-EG')}`,
                    date: firebase.firestore.FieldValue.serverTimestamp(),
                    winner: {
                        player: winner.player,
                        teams: winner.teams
                    },
                    allTeams: allTeams,
                    players: players.map(player => ({
                        name: player.name,
                        teamCount: player.teams.length,
                        remainingTeams: player.teams.filter(t => !t.eliminated).length
                    }))
                };
                
                db.collection('tournaments').doc(currentTournamentId).set(tournamentData)
                    .then(() => {
                        console.log("Tournament saved successfully");
                        analytics.logEvent('tournament_completed');
                    })
                    .catch((error) => {
                        console.error("Error saving tournament: ", error);
                    });
            }
            
            // عرض النتائج النهائية
            function showFinalResults(winner = null) {
                // تبديل إلى تبويب النتائج
                tabs.forEach(t => t.classList.remove('active'));
                Object.values(tabContents).forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="results"]').classList.add('active');
                tabContents.results.classList.add('active');
                
                finalResults.innerHTML = '';
                
                if (winner) {
                    const winnerEl = document.createElement('div');
                    winnerEl.className = 'player winner';
                    winnerEl.innerHTML = `
                        <h3><i class="fas fa-trophy"></i> الفائز: ${winner.player}</h3>
                        <p>عدد الفرق المتبقية: ${winner.count}</p>
                        <p>الفرق الفائزة: ${winner.teams.join('، ')}</p>
                    `;
                    finalResults.appendChild(winnerEl);
                    
                    // عرض منصة التتويج
                    const podium = document.createElement('div');
                    podium.className = 'podium';
                    
                    // الحصول على أفضل 3 لاعبين
                    const rankedPlayers = [...players]
                        .map(p => ({
                            name: p.name,
                            remaining: p.teams.filter(t => !t.eliminated).length,
                            total: p.teams.length
                        }))
                        .sort((a, b) => b.remaining - a.remaining || b.total - a.total);
                    
                    // المركز الأول
                    if (rankedPlayers.length > 0) {
                        const first = document.createElement('div');
                        first.className = 'podium-step podium-first';
                        first.innerHTML = `
                            <div class="podium-rank">1</div>
                            <div class="podium-player">${rankedPlayers[0].name}</div>
                            <div>${rankedPlayers[0].remaining} فريق</div>
                        `;
                        podium.appendChild(first);
                    }
                    
                    // المركز الثاني
                    if (rankedPlayers.length > 1) {
                        const second = document.createElement('div');
                        second.className = 'podium-step podium-second';
                        second.innerHTML = `
                            <div class="podium-rank">2</div>
                            <div class="podium-player">${rankedPlayers[1].name}</div>
                            <div>${rankedPlayers[1].remaining} فريق</div>
                        `;
                        podium.appendChild(second);
                    }
                    
                    // المركز الثالث
                    if (rankedPlayers.length > 2) {
                        const third = document.createElement('div');
                        third.className = 'podium-step podium-third';
                        third.innerHTML = `
                            <div class="podium-rank">3</div>
                            <div class="podium-player">${rankedPlayers[2].name}</div>
                            <div>${rankedPlayers[2].remaining} فريق</div>
                        `;
                        podium.appendChild(third);
                    }
                    
                    finalResults.appendChild(podium);
                }
                
                const playersResults = document.createElement('div');
                playersResults.innerHTML = '<h3><i class="fas fa-users"></i> جميع اللاعبين وفرقهم:</h3>';
                
                players.forEach(player => {
                    const playerEl = document.createElement('div');
                    playerEl.className = 'player';
                    playerEl.innerHTML = `
                        <h3><i class="fas fa-user"></i> ${player.name}</h3>
                        <ul class="team-list">
                            ${player.teams.map(team => `
                                <li class="${team.eliminated ? 'loser' : 'winner'}">
                                    ${team.name} ${team.eliminated ? '<i class="fas fa-times"></i> (خاسر)' : '<i class="fas fa-check"></i> (فائز)'}
                                </li>
                            `).join('')}
                        </ul>
                    `;
                    playersResults.appendChild(playerEl);
                });
                
                finalResults.appendChild(playersResults);
                
                const restartBtn = document.createElement('button');
                restartBtn.className = 'btn-primary';
                restartBtn.innerHTML = '<i class="fas fa-redo"></i> بدء بطولة جديدة';
                restartBtn.addEventListener('click', () => {
                    location.reload();
                });
                finalResults.appendChild(restartBtn);
                
                const historyBtn = document.createElement('button');
                historyBtn.innerHTML = '<i class="fas fa-history"></i> عرض سجل البطولات';
                historyBtn.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    Object.values(tabContents).forEach(c => c.classList.remove('active'));
                    document.querySelector('.tab[data-tab="history"]').classList.add('active');
                    tabContents.history.classList.add('active');
                    loadHistory();
                });
                finalResults.appendChild(historyBtn);
            }
            
            // دالة لخلط المصفوفة عشوائياً
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            
            // تحليل حدث عند تحميل الصفحة
            analytics.logEvent('app_loaded');
        });
    </script>
</body>
</html>